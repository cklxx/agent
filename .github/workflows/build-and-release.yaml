name: Build and Release

on:
  push:
    branches: [ 'main' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ 'main' ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12"

jobs:
  # å…ˆè¿è¡Œæµ‹è¯•ç¡®ä¿ä»£ç è´¨é‡
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv venv --python ${{ env.PYTHON_VERSION }}
        uv pip install -e ".[dev]"
        uv pip install -e ".[test]"

    - name: Run tests
      run: |
        source .venv/bin/activate
        TAVILY_API_KEY=mock-key make test

  # å¤šå¹³å°æž„å»º
  build:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          - os: macos-latest
            platform: macos
            arch: x86_64
          - os: macos-14
            platform: macos
            arch: arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv venv --python ${{ env.PYTHON_VERSION }}
        uv pip install -e ".[dev]"
        uv add --dev pyinstaller

    - name: Test build environment
      run: |
        uv run python packaging/test_build.py

    - name: Build executable
      run: |
        uv run python packaging/build.py

    - name: Test executable (Unix)
      if: runner.os != 'Windows'
      run: |
        chmod +x dist/code_agent
        ./dist/code_agent --help
        echo "Testing RAG enhanced features..."
        echo "RAG Enhanced Code Agent is ready for use"

    - name: Test executable (Windows)
      if: runner.os == 'Windows'
      run: |
        dist\code_agent.exe --help
        echo "Testing RAG enhanced features..."
        echo "RAG Enhanced Code Agent is ready for use"

    - name: Create package name
      id: package_name
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          exe_name="code_agent.exe"
          package_name="code_agent-${{ matrix.platform }}-${{ matrix.arch }}"
        else
          exe_name="code_agent"
          package_name="code_agent-${{ matrix.platform }}-${{ matrix.arch }}"
        fi
        echo "exe_name=$exe_name" >> $GITHUB_OUTPUT
        echo "package_name=$package_name" >> $GITHUB_OUTPUT

    - name: Create distribution package
      shell: bash
      run: |
        package_name="${{ steps.package_name.outputs.package_name }}"
        exe_name="${{ steps.package_name.outputs.exe_name }}"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p "dist/$package_name"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp "dist/$exe_name" "dist/$package_name/"
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œæ–‡æ¡£
        cp conf.yaml.example "dist/$package_name/"
        cp README.md "dist/$package_name/"
        cp packaging/README.md "dist/$package_name/BUILD_README.md"
        
        # åˆ›å»ºç®€å•çš„å¯åŠ¨è¯´æ˜Ž
        cat > "dist/$package_name/README.txt" << EOF
        Code Agent - RAG Enhanced AI Coding Assistant
        ============================================
        
        Quick Start:
        - Run './code_agent --help' (or 'code_agent.exe --help' on Windows) to see available options
        - Run './code_agent --interactive' for interactive mode
        - Copy conf.yaml.example to conf.yaml and configure your settings
        
        For detailed documentation, see README.md and BUILD_README.md
        
        Build info:
        - Platform: ${{ matrix.platform }}-${{ matrix.arch }}
        - Build date: $(date)
        - Git commit: ${{ github.sha }}
        EOF
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        if [ "${{ matrix.platform }}" = "windows" ]; then
          (cd dist && 7z a "$package_name.zip" "$package_name/")
        else
          (cd dist && tar -czf "$package_name.tar.gz" "$package_name/")
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.package_name.outputs.package_name }}
        path: |
          dist/${{ steps.package_name.outputs.package_name }}.*
        retention-days: 30

    - name: Upload executable only (for quick testing)
      uses: actions/upload-artifact@v4
      with:
        name: executable-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/${{ steps.package_name.outputs.exe_name }}
        retention-days: 7

  # åˆ›å»ºReleaseï¼ˆä»…åœ¨æŽ¨é€tagæ—¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release_assets
        
        # ç§»åŠ¨æ‰€æœ‰å¹³å°çš„åŽ‹ç¼©åŒ…åˆ°releaseç›®å½•
        find artifacts -name "*.tar.gz" -exec cp {} release_assets/ \;
        find artifacts -name "*.zip" -exec cp {} release_assets/ \;
        
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        cd release_assets
        for file in *; do
          if [ -f "$file" ]; then
            sha256sum "$file" >> checksums.txt
          fi
        done
        
        ls -la

    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Code Agent ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        files: |
          release_assets/*
        body: |
          # Code Agent ${{ steps.get_version.outputs.version }}
          
          ## ðŸš€ RAGå¢žå¼ºAIç¼–ç¨‹åŠ©æ‰‹
          
          è¿™ä¸ªç‰ˆæœ¬åŒ…å«äº†ä»¥ä¸‹å¹³å°çš„é¢„æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š
          
          ### æ”¯æŒçš„å¹³å°
          - **Linux (x86_64)**: `code_agent-linux-x86_64.tar.gz`
          - **Windows (x86_64)**: `code_agent-windows-x86_64.zip`
          - **macOS (Intel)**: `code_agent-macos-x86_64.tar.gz`
          - **macOS (Apple Silicon)**: `code_agent-macos-arm64.tar.gz`
          
          ### ðŸ”§ å®‰è£…è¯´æ˜Ž
          
          1. ä¸‹è½½é€‚åˆä½ å¹³å°çš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°ä½ é€‰æ‹©çš„ç›®å½•
          3. å¤åˆ¶ `conf.yaml.example` ä¸º `conf.yaml` å¹¶é…ç½®
          4. è¿è¡Œ `./code_agent --help` æŸ¥çœ‹å¯ç”¨é€‰é¡¹
          
          ### âœ¨ æ–°ç‰¹æ€§
          - RAGå¢žå¼ºçš„ä»£ç ç”Ÿæˆå’Œåˆ†æž
          - æ”¯æŒå¤šç§æœç´¢å¼•æ“Žé›†æˆ
          - äº¤äº’å¼å’Œå‘½ä»¤è¡Œæ¨¡å¼
          - å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿ
          
          ### ðŸ”’ æ ¡éªŒå’Œ
          æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒè¯·å‚è€ƒ `checksums.txt`
          
          ---
          
          **æž„å»ºä¿¡æ¯:**
          - Git Commit: ${{ github.sha }}
          - æž„å»ºæ—¶é—´: ${{ github.run_id }}
          
          å¦‚æœ‰é—®é¢˜è¯·è®¿é—® [GitHub Issues](https://github.com/${{ github.repository }}/issues)

  # æž„å»ºçŠ¶æ€æ±‡æ€»
  build-summary:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Status" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Multi-platform Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Platforms" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Linux x86_64" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Windows x86_64" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… macOS x86_64" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… macOS ARM64" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Built executables are available as workflow artifacts for testing." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "### ðŸ“¦ Development Build" >> $GITHUB_STEP_SUMMARY
          echo "This is a development build from main branch. Download artifacts for testing." >> $GITHUB_STEP_SUMMARY
        fi 