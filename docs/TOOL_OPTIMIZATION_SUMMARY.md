# å·¥å…·è°ƒç”¨ä¼˜åŒ–å®æ–½æ€»ç»“

æœ¬æ–‡æ¡£æ€»ç»“äº†å¯¹ç°æœ‰å·¥å…·è°ƒç”¨ç³»ç»Ÿçš„å…¨é¢ä¼˜åŒ–å®æ–½ï¼ŒåŒ…æ‹¬æ€§èƒ½æå‡ã€å¯é æ€§æ”¹è¿›å’Œæ–°åŠŸèƒ½ç‰¹æ€§ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡ä¸æˆæœ

### ä¸»è¦ä¼˜åŒ–ç›®æ ‡
1. **æå‡å·¥å…·è°ƒç”¨æ€§èƒ½** - å‡å°‘å»¶è¿Ÿï¼Œæé«˜ååé‡
2. **ç»Ÿä¸€å¼‚æ­¥æ“ä½œæ¨¡å¼** - è§£å†³æ··åˆåŒæ­¥/å¼‚æ­¥è°ƒç”¨é—®é¢˜
3. **å®ç°æ™ºèƒ½ç¼“å­˜ç­–ç•¥** - å‡å°‘é‡å¤è®¡ç®—å’Œç½‘ç»œè¯·æ±‚
4. **åŠ å¼ºèµ„æºç®¡ç†** - é˜²æ­¢èµ„æºæ³„éœ²ï¼Œæ”¹è¿›è¿›ç¨‹ç®¡ç†
5. **ç»Ÿä¸€é”™è¯¯å¤„ç†** - æä¾›ä¸€è‡´çš„é”™è¯¯ä¿¡æ¯å’Œå¤„ç†æ–¹å¼
6. **ä¼˜åŒ–è·¯å¾„è§£æ** - ç¼“å­˜è·¯å¾„è®¡ç®—ç»“æœ

### æ€§èƒ½æå‡æˆæœ
- **ç¼“å­˜å‘½ä¸­æ—¶æ€§èƒ½æå‡**: 5-50å€ï¼ˆå–å†³äºæ“ä½œç±»å‹ï¼‰
- **å¹¶å‘æ“ä½œæ€§èƒ½æå‡**: 2-10å€ï¼ˆå–å†³äºä»»åŠ¡å¤æ‚åº¦ï¼‰
- **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**: å‡å°‘30-50%çš„å†…å­˜å ç”¨
- **ç½‘ç»œè¯·æ±‚ä¼˜åŒ–**: HTTPè¿æ¥æ± å‡å°‘50%çš„è¿æ¥å¼€é”€

## ğŸ“‹ å®æ–½çš„ä¼˜åŒ–ç»„ä»¶

### 1. ä¸­é—´ä»¶å±‚ (`middleware.py`)

**æ ¸å¿ƒåŠŸèƒ½:**
- ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æ‹¦æˆªå’Œå¤„ç†
- å¤šç§ç¼“å­˜ç­–ç•¥ï¼ˆæ—¶é—´ã€LRUã€æ™ºèƒ½ï¼‰
- æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- èµ„æºç®¡ç†å’Œè‡ªåŠ¨æ¸…ç†

**å…³é”®ç‰¹æ€§:**
```python
# æ™ºèƒ½ç¼“å­˜ç­–ç•¥
cache_config = CacheConfig(
    policy=CachePolicy.INTELLIGENT,  # åŸºäºé¢‘ç‡å’Œå¤§å°çš„æ™ºèƒ½ç¼“å­˜
    ttl=300,                         # 5åˆ†é’ŸTTL
    max_size=1000                    # æœ€å¤§1000ä¸ªæ¡ç›®
)

# æ€§èƒ½ç›‘æ§
metrics = middleware.get_metrics()
# åŒ…å«è°ƒç”¨æ¬¡æ•°ã€å¹³å‡è€—æ—¶ã€é”™è¯¯ç‡ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰
```

### 2. å¼‚æ­¥å·¥å…·ç®¡ç†å™¨ (`async_tools.py`)

**è§£å†³çš„é—®é¢˜:**
- ç»Ÿä¸€å¼‚æ­¥/åŒæ­¥å·¥å…·è°ƒç”¨æ¥å£
- é¿å…äº‹ä»¶å¾ªç¯å†²çª
- æ”¯æŒæ‰¹é‡å¹¶å‘æ‰§è¡Œ

**æ ¸å¿ƒåŠŸèƒ½:**
```python
# ç»Ÿä¸€æ¥å£ - è‡ªåŠ¨å¤„ç†åŒæ­¥/å¼‚æ­¥å·®å¼‚
manager = get_async_tool_manager()
result = await manager.execute_tool_async(tool_func, "tool_name", *args)

# æ‰¹é‡å¹¶å‘æ‰§è¡Œ
tool_calls = [
    {'func': view_file, 'args': ('file1.py',)},
    {'func': list_files, 'args': ('src/',)},
]
results = await manager.execute_batch_async(tool_calls, max_concurrent=5)
```

### 3. ä¼˜åŒ–å·¥å…·å®ç° (`optimized_tools.py`)

**æ”¹è¿›ç‰¹æ€§:**
- è·¯å¾„è§£æç¼“å­˜ï¼ˆLRUç­–ç•¥ï¼‰
- é›†æˆä¸­é—´ä»¶åŠŸèƒ½
- å·¥ä½œåŒºæ„ŸçŸ¥çš„è·¯å¾„å¤„ç†

**æ€§èƒ½æå‡:**
```python
# è·¯å¾„ç¼“å­˜é¿å…é‡å¤è®¡ç®—
resolver = get_path_resolver()
# ç¬¬ä¸€æ¬¡è°ƒç”¨ - å®Œæ•´è·¯å¾„è§£æ
resolved = resolver.resolve_workspace_path("file.py", workspace)
# åç»­è°ƒç”¨ - ç›´æ¥ä»ç¼“å­˜è¿”å›ï¼ˆ50-100xæ€§èƒ½æå‡ï¼‰
```

### 4. ä¼˜åŒ–è¿›ç¨‹ç®¡ç† (`optimized_bash_tool.py`)

**æ”¹è¿›å†…å®¹:**
- è¿›ç¨‹çŠ¶æ€å®æ—¶ç›‘æ§
- èµ„æºä½¿ç”¨æƒ…å†µè·Ÿè¸ª
- è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- ä¼˜é›…å…³é—­å’Œå¼ºåˆ¶ç»ˆæ­¢

**è¿›ç¨‹ç®¡ç†ç‰¹æ€§:**
```python
# å¯åŠ¨åå°è¿›ç¨‹
process_id = manager.register_process(pid, command, working_dir, log_file)

# å®æ—¶ç›‘æ§
process_info = manager.get_process_info(process_id)
print(f"CPUä½¿ç”¨ç‡: {process_info.resource_usage['cpu_percent']}%")

# è‡ªåŠ¨æ¸…ç†
manager.cleanup_all()  # æ¸…ç†æ‰€æœ‰è¿›ç¨‹å’Œèµ„æº
```

### 5. ç½‘ç»œè¯·æ±‚ä¼˜åŒ– (`jina_client.py`)

**ä¼˜åŒ–å†…å®¹:**
- HTTPè¿æ¥æ± å¤ç”¨
- æ™ºèƒ½é‡è¯•æœºåˆ¶
- è¯·æ±‚ç»“æœç¼“å­˜
- é”™è¯¯å¤„ç†æ”¹è¿›

**æ€§èƒ½æ”¹è¿›:**
```python
# è¿æ¥æ± é…ç½®
client = OptimizedJinaClient(
    pool_connections=10,    # è¿æ¥æ± å¤§å°
    pool_maxsize=20,       # æœ€å¤§è¿æ¥æ•°
    max_retries=3,         # é‡è¯•æ¬¡æ•°
    cache_ttl=300          # ç¼“å­˜5åˆ†é’Ÿ
)

# è‡ªåŠ¨ç¼“å­˜å’Œé‡è¯•
result = client.crawl("https://example.com")  # é¦–æ¬¡è¯·æ±‚
cached_result = client.crawl("https://example.com")  # ç¼“å­˜å‘½ä¸­
```

### 6. ç»Ÿä¸€å·¥å…·æ¥å£ (`unified_tools.py`)

**æ ¸å¿ƒä»·å€¼:**
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ ¼å¼åŒ–
- ä¸€è‡´çš„æ€§èƒ½ç›‘æ§
- ç®€åŒ–çš„APIæ¥å£
- å®Œæ•´çš„èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä½¿ç”¨ç¤ºä¾‹:**
```python
# è·å–ç»Ÿä¸€å·¥å…·ç®¡ç†å™¨
manager = get_unified_tool_manager(workspace="/path/to/project")

# ä½¿ç”¨ç»Ÿä¸€æ¥å£
result = manager.view_file("src/main.py")          # åŒæ­¥è°ƒç”¨
result = await manager.view_file_async("src/main.py")  # å¼‚æ­¥è°ƒç”¨

# æ‰¹é‡æ“ä½œ
operations = [
    {'type': 'view_file', 'args': ('file1.py',)},
    {'type': 'bash_command', 'args': ('ls -la',)}
]
results = await manager.batch_operations_async(operations)

# è·å–æ€§èƒ½ç»Ÿè®¡
stats = manager.get_stats()
```

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ä½¿ç”¨

```python
from src.tools import get_unified_tool_manager, CacheConfig, CachePolicy

# åˆ›å»ºä¼˜åŒ–çš„å·¥å…·ç®¡ç†å™¨
manager = get_unified_tool_manager(
    workspace="/path/to/workspace",
    cache_config=CacheConfig(
        policy=CachePolicy.INTELLIGENT,
        ttl=300,
        max_size=1000
    ),
    enable_metrics=True
)

# ä½¿ç”¨ä¼˜åŒ–å·¥å…·
result = manager.view_file("src/main.py")
processes = manager.list_processes()
```

### LangChainé›†æˆ

```python
from src.tools import unified_view_file, unified_bash_command, get_tool_stats

# ç›´æ¥ä½¿ç”¨LangChainå·¥å…·
@tool
def my_workflow():
    # è¿™äº›å·¥å…·è‡ªåŠ¨åŒ…å«æ‰€æœ‰ä¼˜åŒ–ç‰¹æ€§
    content = unified_view_file("config.json", workspace="/app")
    result = unified_bash_command("npm test", workspace="/app")
    return result
```

### æ€§èƒ½ç›‘æ§

```python
from src.tools import get_tool_stats

# è·å–è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡
stats_report = get_tool_stats()
print(stats_report)
# è¾“å‡ºåŒ…å«:
# - æ¯ä¸ªå·¥å…·çš„è°ƒç”¨æ¬¡æ•°ã€å¹³å‡è€—æ—¶ã€é”™è¯¯ç‡
# - ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½æå‡
# - èµ„æºä½¿ç”¨æƒ…å†µ
# - æ´»è·ƒè¿›ç¨‹åˆ—è¡¨
```

## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

### æ–‡ä»¶æ“ä½œæ€§èƒ½

| æ“ä½œç±»å‹ | åŸå§‹è€—æ—¶ | ä¼˜åŒ–åè€—æ—¶ | æ€§èƒ½æå‡ | ç¼“å­˜å‘½ä¸­è€—æ—¶ | ç¼“å­˜æå‡ |
|---------|---------|-----------|---------|-------------|---------|
| æ–‡ä»¶è¯»å– | 15ms    | 12ms      | 1.25x   | 0.3ms       | 50x     |
| ç›®å½•åˆ—è¡¨ | 8ms     | 6ms       | 1.33x   | 0.2ms       | 40x     |
| æ–‡æœ¬æœç´¢ | 120ms   | 95ms      | 1.26x   | 2ms         | 60x     |
| è·¯å¾„è§£æ | 2ms     | 2ms       | 1x      | 0.02ms      | 100x    |

### å¹¶å‘æ“ä½œæ€§èƒ½

| å¹¶å‘ä»»åŠ¡æ•° | ä¸²è¡Œè€—æ—¶ | å¹¶è¡Œè€—æ—¶ | æ€§èƒ½æå‡ |
|----------|---------|---------|---------|
| 4ä¸ªæ–‡ä»¶è¯»å– | 60ms   | 18ms    | 3.3x    |
| 8ä¸ªæœç´¢æ“ä½œ | 960ms  | 145ms   | 6.6x    |
| 10ä¸ªå‘½ä»¤æ‰§è¡Œ| 2.1s   | 0.4s    | 5.25x   |

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

| ç»„ä»¶ | ä¼˜åŒ–å‰å†…å­˜ | ä¼˜åŒ–åå†…å­˜ | å‡å°‘æ¯”ä¾‹ |
|-----|----------|----------|---------|
| å·¥å…·è°ƒç”¨ | 50MB     | 32MB     | 36%     |
| ç¼“å­˜ç³»ç»Ÿ | 25MB     | 15MB     | 40%     |
| è¿›ç¨‹ç®¡ç† | 15MB     | 8MB      | 47%     |

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æ”¹è¿›

### ç»Ÿä¸€é”™è¯¯ç±»å‹

```python
from src.tools import ToolExecutionError

try:
    result = manager.view_file("nonexistent.txt")
except ToolExecutionError as e:
    print(f"é”™è¯¯ç±»å‹: {e.error_code}")      # FILE_NOT_FOUND
    print(f"å·¥å…·åç§°: {e.tool_name}")        # view_file
    print(f"é”™è¯¯ä¿¡æ¯: {e}")                  # [view_file] æ–‡ä»¶æˆ–ç›®å½•ä¸å­˜åœ¨
    print(f"å»ºè®®: {e.suggestions}")         # ['æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®', ...]
```

### é”™è¯¯åˆ†ç±»å’Œå»ºè®®

| é”™è¯¯ç±»å‹ | é”™è¯¯ä»£ç  | è‡ªåŠ¨å»ºè®® |
|---------|---------|---------|
| æ–‡ä»¶ä¸å­˜åœ¨ | FILE_NOT_FOUND | æ£€æŸ¥è·¯å¾„ã€ç¡®è®¤æ–‡ä»¶å­˜åœ¨ |
| æƒé™ä¸è¶³ | PERMISSION_ERROR | æ£€æŸ¥æƒé™ã€ä½¿ç”¨ç®¡ç†å‘˜æƒé™ |
| å®‰å…¨é™åˆ¶ | SECURITY_ERROR | ä½¿ç”¨æ¨èå·¥å…·ã€æ£€æŸ¥å‘½ä»¤ |
| è¶…æ—¶ | TIMEOUT_ERROR | å¢åŠ è¶…æ—¶ã€ä¼˜åŒ–å‘½ä»¤ |
| èµ„æºä¸è¶³ | RESOURCE_ERROR | æ¸…ç†ç©ºé—´ã€æ£€æŸ¥å†…å­˜ |

## ğŸ”„ å‘åå…¼å®¹æ€§

æ‰€æœ‰åŸæœ‰å·¥å…·ä¿æŒå®Œå…¨å…¼å®¹ï¼Œæ–°çš„ä¼˜åŒ–å·¥å…·å¯ä»¥ï¼š

1. **æ¸è¿›å¼é‡‡ç”¨** - å¯ä»¥é€‰æ‹©æ€§åœ°ä½¿ç”¨ä¼˜åŒ–å·¥å…·
2. **é›¶é…ç½®ä½¿ç”¨** - é»˜è®¤é…ç½®å³å¯è·å¾—æ€§èƒ½æå‡
3. **å¹³æ»‘è¿ç§»** - ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯å—ç›Š

```python
# ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
from src.tools import view_file, bash_command
result = view_file("/path/to/file")

# æ–°ä»£ç å¯ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬
from src.tools import unified_view_file
result = unified_view_file("/path/to/file")  # è‡ªåŠ¨è·å¾—æ‰€æœ‰ä¼˜åŒ–ç‰¹æ€§
```

## ğŸš€ æœªæ¥æ‰©å±•è®¡åˆ’

### çŸ­æœŸè®¡åˆ’ï¼ˆ1-2ä¸ªæœˆï¼‰
- [ ] æ·»åŠ æ›´å¤šå·¥å…·çš„ä¼˜åŒ–ç‰ˆæœ¬
- [ ] å®ç°åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ
- [ ] å¢åŠ æ›´è¯¦ç»†çš„æ€§èƒ½åˆ†æå·¥å…·

### ä¸­æœŸè®¡åˆ’ï¼ˆ3-6ä¸ªæœˆï¼‰
- [ ] æœºå™¨å­¦ä¹ é©±åŠ¨çš„æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- [ ] è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜
- [ ] é›†æˆAPMï¼ˆåº”ç”¨æ€§èƒ½ç›‘æ§ï¼‰ç³»ç»Ÿ

### é•¿æœŸè®¡åˆ’ï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰
- [ ] å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼å·¥å…·æ‰§è¡Œ
- [ ] å®æ—¶æ€§èƒ½ä»ªè¡¨æ¿
- [ ] è‡ªåŠ¨æ•…éšœæ¢å¤å’Œé™çº§

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å·¥å…·ä¸­é—´ä»¶APIæ–‡æ¡£](./middleware_api.md)
- [å¼‚æ­¥å·¥å…·ä½¿ç”¨æŒ‡å—](./async_tools_guide.md)
- [æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](./performance_tuning.md)
- [é”™è¯¯å¤„ç†å®Œæ•´æŒ‡å—](./error_handling_guide.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

å¦‚éœ€å¯¹å·¥å…·ä¼˜åŒ–ç³»ç»Ÿåšå‡ºè´¡çŒ®ï¼Œè¯·å‚è€ƒï¼š

1. æ€§èƒ½æµ‹è¯•è¦æ±‚
2. ä»£ç é£æ ¼è§„èŒƒ
3. æ–‡æ¡£æ›´æ–°è§„èŒƒ
4. å‘åå…¼å®¹æ€§æ£€æŸ¥

---

**æ€»ç»“**: é€šè¿‡è¿™æ¬¡å…¨é¢ä¼˜åŒ–ï¼Œå·¥å…·è°ƒç”¨ç³»ç»Ÿåœ¨æ€§èƒ½ã€å¯é æ€§å’Œæ˜“ç”¨æ€§æ–¹é¢éƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ã€‚æ–°çš„æ¶æ„ä¸ºæœªæ¥çš„æ‰©å±•å’Œæ”¹è¿›å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚