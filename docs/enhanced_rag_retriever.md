# å¢å¼ºRAGæ£€ç´¢å™¨

## æ¦‚è¿°

å¢å¼ºRAGæ£€ç´¢å™¨(`EnhancedRAGRetriever`)æ˜¯ä¸€ä¸ªç»“åˆäº†å‘é‡ç›¸ä¼¼åº¦å¬å›å’Œå€’æ’ç´¢å¼•å¬å›çš„æ··åˆæœç´¢ç³»ç»Ÿã€‚å®ƒåœ¨åŸæœ‰çš„ä»£ç æ£€ç´¢å™¨åŸºç¡€ä¸Šï¼Œå¢åŠ äº†åŸºäºembedding APIçš„è¯­ä¹‰æœç´¢èƒ½åŠ›ï¼Œå®ç°äº†æ›´ç²¾å‡†çš„ä»£ç æ£€ç´¢ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ” æ··åˆæœç´¢ç®—æ³•
- **å‘é‡ç›¸ä¼¼åº¦å¬å›**: ä½¿ç”¨embedding APIè·å–æ–‡æœ¬å‘é‡ï¼Œé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œè¯­ä¹‰æœç´¢
- **å€’æ’ç´¢å¼•å¬å›**: åŸºäºTF-IDFçš„å…³é”®è¯åŒ¹é…æœç´¢
- **æ™ºèƒ½æƒé‡èåˆ**: å¯é…ç½®çš„æƒé‡ç³»ç»Ÿï¼ŒåŠ¨æ€å¹³è¡¡ä¸¤ç§å¬å›æ–¹å¼

### ğŸš€ å¤šç§Embeddingæ”¯æŒ
- é˜¿é‡Œäº‘ç™¾ç‚¼DashScope API (text-embedding-v3/v4) ğŸ‡¨ğŸ‡³
- OpenAI API (text-embedding-3-small/large)
- OpenRouter API
- Azure OpenAI
- æœ¬åœ°éƒ¨ç½²çš„embeddingæœåŠ¡
- Hugging Face API

### ğŸ“Š é«˜æ€§èƒ½å­˜å‚¨
- **å‘é‡å­˜å‚¨**: åŸºäºChromaDBçš„é«˜æ•ˆå‘é‡æ•°æ®åº“
- **å…³é”®è¯ç´¢å¼•**: SQLite + TF-IDFçš„å€’æ’ç´¢å¼•
- **è‡ªåŠ¨ç´¢å¼•æ„å»º**: æ”¯æŒå¢é‡ç´¢å¼•å’Œæ‰¹é‡é‡å»º

### âš¡ å¼‚æ­¥æ”¯æŒ
- å®Œå…¨å¼‚æ­¥çš„APIè®¾è®¡
- æ‰¹é‡embeddingå¤„ç†
- å¹¶å‘æœç´¢ä¼˜åŒ–

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EnhancedRAGRetriever                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EmbeddingClient â”‚  â”‚   VectorStore   â”‚  â”‚KeywordIndex â”‚  â”‚
â”‚  â”‚   (OpenAI API)  â”‚  â”‚   (ChromaDB)    â”‚  â”‚ (TF-IDF)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    BaseCodeRetriever                        â”‚
â”‚                  (æ–‡ä»¶ç´¢å¼• + åŸºç¡€æ£€ç´¢)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬åˆå§‹åŒ–

```python
from rag.enhanced_retriever import EnhancedRAGRetriever

# ä½¿ç”¨é»˜è®¤é…ç½®
retriever = EnhancedRAGRetriever(
    repo_path="/path/to/your/repo",
    db_path="temp/rag_data/enhanced_rag"
)

# ä½¿ç”¨è‡ªå®šä¹‰embeddingé…ç½®
embedding_config = {
    "base_url": "https://api.openai.com/v1",
    "model": "text-embedding-3-small", 
    "api_key": "your-api-key"
}

retriever = EnhancedRAGRetriever(
    repo_path="/path/to/your/repo",
    db_path="temp/rag_data/enhanced_rag",
    embedding_config=embedding_config
)
```

### æ··åˆæœç´¢

```python
# å¼‚æ­¥æ··åˆæœç´¢
results = await retriever.hybrid_search(
    query="å‘é‡ç›¸ä¼¼åº¦ç®—æ³•",
    n_results=5,
    vector_weight=0.7,    # å‘é‡æƒé‡
    keyword_weight=0.3    # å…³é”®è¯æƒé‡
)

for result in results:
    print(f"æ–‡æ¡£: {result.document.title}")
    print(f"å‘é‡å¾—åˆ†: {result.vector_score:.3f}")
    print(f"å…³é”®è¯å¾—åˆ†: {result.keyword_score:.3f}")
    print(f"ç»¼åˆå¾—åˆ†: {result.combined_score:.3f}")
```

### æ ‡å‡†Retrieveræ¥å£

```python
# å…¼å®¹åŸæœ‰çš„Retrieveræ¥å£
documents = retriever.query_relevant_documents("ä»£ç æ£€ç´¢")
resources = retriever.list_resources("python")
```

## é…ç½®è¯´æ˜

### Embeddingé…ç½®

æ”¯æŒå¤šç§embeddingæœåŠ¡é…ç½®ï¼š

```yaml
# OpenAI
openai:
  base_url: "https://api.openai.com/v1"
  model: "text-embedding-3-small"
  api_key: "${OPENAI_API_KEY}"
  dimensions: 1536

# OpenRouter
openrouter:
  base_url: "https://openrouter.ai/api/v1"
  model: "openai/text-embedding-3-small"
  api_key: "${OPENROUTER_API_KEY}"

# æœ¬åœ°æœåŠ¡
local:
  base_url: "http://localhost:8080/v1"
  model: "sentence-transformers/all-MiniLM-L6-v2"
  api_key: "not-required"
```

### æƒé‡é…ç½®

```yaml
search_weights:
  vector_weight: 0.6      # å‘é‡ç›¸ä¼¼åº¦æƒé‡
  keyword_weight: 0.4     # å…³é”®è¯åŒ¹é…æƒé‡
  
  # æ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒæ•´
  query_type_weights:
    semantic_search:
      vector_weight: 0.8
      keyword_weight: 0.2
    keyword_search:
      vector_weight: 0.3
      keyword_weight: 0.7
```

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡å¤„ç†
- embeddingè·å–æ”¯æŒæ‰¹é‡å¤„ç†ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°
- ç´¢å¼•æ„å»ºé‡‡ç”¨æ‰¹é‡æ’å…¥ï¼Œæå‡å»ºåº“é€Ÿåº¦

### ç¼“å­˜æœºåˆ¶
- embeddingç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- æŸ¥è¯¢ç»“æœç¼“å­˜ï¼Œæå‡å“åº”é€Ÿåº¦

### å¼‚æ­¥ä¼˜åŒ–
- å…¨å¼‚æ­¥APIè®¾è®¡ï¼Œæ”¯æŒé«˜å¹¶å‘
- å‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢å¹¶è¡Œæ‰§è¡Œ

## è¯„ä¼°æŒ‡æ ‡

ç³»ç»Ÿæä¾›å¤šç»´åº¦çš„æ£€ç´¢è´¨é‡è¯„ä¼°ï¼š

### å¬å›ç‡æŒ‡æ ‡
- **å‘é‡å¬å›å‡†ç¡®ç‡**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„å¬å›è´¨é‡
- **å…³é”®è¯å¬å›å‡†ç¡®ç‡**: åŸºäºå…³é”®è¯åŒ¹é…çš„å¬å›è´¨é‡  
- **æ··åˆå¬å›æ•ˆæœ**: ä¸¤ç§æ–¹å¼ç»“åˆåçš„æ•´ä½“æ•ˆæœ

### æ€§èƒ½æŒ‡æ ‡
- **ç´¢å¼•æ„å»ºæ—¶é—´**: ä¸åŒè§„æ¨¡ä»£ç åº“çš„ç´¢å¼•æ„å»ºè€—æ—¶
- **æŸ¥è¯¢å“åº”æ—¶é—´**: å•æ¬¡æŸ¥è¯¢çš„å¹³å‡å“åº”æ—¶é—´
- **å¹¶å‘å¤„ç†èƒ½åŠ›**: åŒæ—¶å¤„ç†å¤šä¸ªæŸ¥è¯¢çš„èƒ½åŠ›

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„Embeddingæ¨¡å‹
- **ä»£ç æœç´¢**: æ¨èä½¿ç”¨text-embedding-3-smallï¼Œå¹³è¡¡æ•ˆæœå’Œæˆæœ¬
- **è¯­ä¹‰æœç´¢**: æ¨èä½¿ç”¨text-embedding-3-largeï¼Œè·å¾—æ›´å¥½çš„è¯­ä¹‰ç†è§£
- **æœ¬åœ°éƒ¨ç½²**: æ¨èsentence-transformersæ¨¡å‹ï¼Œæ— éœ€APIè°ƒç”¨

### 2. è°ƒæ•´æƒé‡é…ç½®
- **æŠ€æœ¯æ–‡æ¡£**: æé«˜å‘é‡æƒé‡(0.7-0.8)ï¼Œé‡è§†è¯­ä¹‰ç†è§£
- **APIæœç´¢**: æé«˜å…³é”®è¯æƒé‡(0.6-0.7)ï¼Œé‡è§†ç²¾ç¡®åŒ¹é…
- **æ··åˆæŸ¥è¯¢**: ä½¿ç”¨é»˜è®¤æƒé‡(å‘é‡0.6ï¼Œå…³é”®è¯0.4)

### 3. ç´¢å¼•ç»´æŠ¤
- å®šæœŸé‡å»ºç´¢å¼•ä»¥åŒ…å«æ–°ä»£ç 
- ç›‘æ§ç´¢å¼•å¤§å°å’ŒæŸ¥è¯¢æ€§èƒ½
- æ ¹æ®ä½¿ç”¨æ¨¡å¼è°ƒæ•´ç¼“å­˜ç­–ç•¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Embedding APIè°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡çŠ¶æ€
   - ç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€åˆ°å…³é”®è¯æœç´¢

2. **ç´¢å¼•æ„å»ºç¼“æ…¢**
   - å‡å°‘batch_sizeé™ä½å†…å­˜ä½¿ç”¨
   - å¯ç”¨å¹¶è¡Œç´¢å¼•æ„å»º
   - æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³

3. **æœç´¢ç»“æœä¸ç›¸å…³**
   - è°ƒæ•´å‘é‡å’Œå…³é”®è¯çš„æƒé‡æ¯”ä¾‹
   - æ£€æŸ¥embeddingæ¨¡å‹æ˜¯å¦é€‚åˆå½“å‰åœºæ™¯
   - è€ƒè™‘é‡æ–°è®­ç»ƒæˆ–é€‰æ‹©å…¶ä»–æ¨¡å‹

### æ€§èƒ½ç›‘æ§

```python
# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = retriever.get_statistics()
print(f"å‘é‡å­˜å‚¨æ–‡æ¡£æ•°: {stats['vector_store_count']}")
print(f"ç´¢å¼•çŠ¶æ€: {stats['enhanced_indexing']}")
print(f"å½“å‰æƒé‡: å‘é‡{stats['vector_weight']}, å…³é”®è¯{stats['keyword_weight']}")
```

## ç¤ºä¾‹ä»£ç 

å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒï¼š
- `examples/enhanced_rag_demo.py` - åŠŸèƒ½æ¼”ç¤º
- `tests/test_enhanced_retriever.py` - å•å…ƒæµ‹è¯•

## æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒæ›´å¤šembeddingæ¨¡å‹
- [ ] å®ç°å¢é‡ç´¢å¼•æ›´æ–°
- [ ] æ·»åŠ æŸ¥è¯¢æ„å›¾è¯†åˆ«
- [ ] æ”¯æŒå¤šæ¨¡æ€æ£€ç´¢ï¼ˆä»£ç +æ–‡æ¡£+å›¾ç‰‡ï¼‰
- [ ] é›†æˆæ›´å¤šå‘é‡æ•°æ®åº“åç«¯ 